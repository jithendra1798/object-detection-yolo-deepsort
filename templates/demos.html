<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Demos - Object Tracking</title>
    <style>
      body { font-family: sans-serif; margin: 16px }
      .pair { display:flex; gap:12px; margin-bottom:24px }
      .half { flex:1; border:1px solid #ddd; padding:8px }
      video { width:100%; height:auto; background:#000 }
      .try { display:block; margin:24px auto; padding:12px 20px; background:#2196F3; color:#fff; border-radius:6px; text-decoration:none; font-size:18px; text-align:center }
    </style>
  </head>
  <body>
    <a class="try" href="/">Try it yourself</a>
    <h1>Demo Videos</h1>

    {% for p in pairs %}
    <div class="pair">
      <div class="half">
        <h3>Original {{ loop.index }}</h3>
        <video controls src="{{ p.original }}"></video>
      </div>
      <div class="half">
        <h3>Processed {{ loop.index }}</h3>
        <video controls src="{{ p.processed_initial }}" data-target="{{ p.processed_target }}"></video>
      </div>
    </div>
    {% endfor %}

    <script>
      (function() {
        const MAX_CHECKS = 30;
        const CHECK_DELAY_MS = 2000;

        if (!window.fetch) {
          return;
        }

        const scheduleCheck = (video, target, attempts) => {
          if (attempts >= MAX_CHECKS) {
            return;
          }
          setTimeout(() => checkAvailability(video, target, attempts + 1), CHECK_DELAY_MS);
        };

        const checkAvailability = (video, target, attempt) => {
          const cacheBusted = `${target}${target.includes('?') ? '&' : '?'}t=${Date.now()}`;
          fetch(cacheBusted, { method: 'HEAD' })
            .then((res) => {
              if (res.ok) {
                video.src = cacheBusted;
                video.load();
                const playPromise = video.play();
                if (playPromise && typeof playPromise.catch === 'function') {
                  playPromise.catch(() => {});
                }
              } else {
                scheduleCheck(video, target, attempt);
              }
            })
            .catch(() => {
              scheduleCheck(video, target, attempt);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('video[data-target]').forEach((video) => {
            const target = video.dataset.target;
            const initialSrc = video.getAttribute('src');
            if (!target || initialSrc === target) {
              return;
            }
            checkAvailability(video, target, 0);
          });
        });
      })();
    </script>

  </body>
</html>
